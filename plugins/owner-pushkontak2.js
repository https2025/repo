import fs from "fs";
import { promisify } from "util";
import path from "path";
import { fileURLToPath } from "url";

const writeFileAsync = promisify(fs.writeFile);

let handler = async (
  m,
  { conn, usedPrefix, command, isGroup, groupMetadata, text },
) => {
  if (!text || !text.includes("|")) {
    return conn.reply(
      m.chat,
      `Penggunaan salah, silahkan gunakan command seperti ini\n${usedPrefix}${command} id|tekspushkontak\n\nJika tidak mengetahui Id grup, ketik .idgroup`,
      m,
    );
  }

  const metadata2 = await conn.groupMetadata(text.split("|")[0]);
  const halss = metadata2.participants;

  let contacts = [];

  for (let mem of halss) {
    await sleep(10000); // Delay 3 detik
    const number = `${mem.id.split("@")[0]}@s.whatsapp.net`;
    conn.sendMessage(number, { text: text.split("|")[1] });

    contacts.push(number);
  }

  // Membuat file contacts.vcf
  const vcfData = contacts
    .map((number) => {
      const formattedNumber = number.split("@")[0];
      return `BEGIN:VCARD\nVERSION:3.0\nFN:RKCORPJB - ${formattedNumber}\nTEL;type=CELL;type=VOICE;waid=${formattedNumber}:${formattedNumber}\nEND:VCARD`;
    })
    .join("\n");

  // Mendapatkan path direktori saat ini
  const __filename = fileURLToPath(import.meta.url);
  const __dirname = path.dirname(__filename);
  const vcfPath = path.join(__dirname, "contacts.vcf");

  await writeFileAsync(vcfPath, vcfData);

  // Mengirim file contacts.vcf dengan caption
  const sentMessage = await conn.sendMessage(m.chat, {
    document: { url: vcfPath },
    mimetype: "text/vcard",
    fileName: "contacts.vcf",
    caption: "Sukses Pushkontak",
  });

  // Menghapus file setelah 10 detik
  setTimeout(() => {
    fs.unlinkSync(vcfPath);
  }, 10000); // 10000 ms = 10 detik

  return conn.reply(m.chat, "Done Pushkontak", m);
};

handler.command = ["pushkontak1"];
handler.tags = ["owner"];
handler.owner = true;
handler.group = false;

export default handler;

async function sleep(ms) {
  return new Promise((resolve) => setTimeout(resolve, ms));
}

/*Generated By Ai
Prompter: 3sideOcd
*/
